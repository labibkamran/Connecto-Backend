# Backend Template — Detailed Setup & Conventions

This repository is a TypeScript + Node backend template. It includes example wiring for Express, Mongoose, dotenv (local), autogenerated Swagger docs, password utilities using argon2, and a recommended project layout. Secrets are managed using Doppler for secure secret injection.

Table of contents
- Prerequisites
- Running locally (Doppler or .env)
- Installing dependencies
- NPM scripts
- Swagger (autogenerated)
- Project structure and folder conventions
- Controllers & versioning
- Env variables and secrets
- Adding new routes, controllers, models
- Password utilities
- Testing and linting
- Deployment notes

Prerequisites
- Node.js (v16+ recommended; tested on v18). Ensure native build tools are available for some packages (argon2).
- MongoDB instance or Atlas cluster reachable via `MONGO_URI`.
- Doppler CLI (optional, recommended for managing secrets).

Running locally

Using Doppler (recommended):

```bash
# Run the dev server with Doppler-injected environment variables
doppler run -- npm run dev
```

Using a local `.env` file (only for quick testing):

```bash
# copy example and edit values
cp .env.example .env
npm run dev
```

Installing dependencies

```bash
npm install
```

Recommended dev packages (if not already installed): typescript, ts-node-dev, @types/node

```bash
npm install -D typescript ts-node-dev @types/node
```

Key npm scripts
- `npm run dev` — start development server with auto-reload (ts-node-dev)
- `npm run build` — compile TypeScript into `dist/`
- `npm run start` — run compiled server from `dist/`
- `npm run type-check` — run the TypeScript compiler for type-only checking

Swagger (autogenerated)

This project uses `swagger-jsdoc` + `swagger-ui-express` to generate an OpenAPI spec from configuration and JSDoc annotations. The Swagger server is mounted at `/docs` and the raw spec is available at `/docs/spec.json`.

Notes about the implementation:
- The Swagger implementation lives entirely under `src/docs` — do not place swagger code outside that directory.
- The spec is created from the definition in `src/docs/swagger.ts` and from JSDoc comments when `apis` is configured to include source files. To include route/controller JSDoc comments, set `apis: ['src/controllers/**/*.ts']` in `src/docs/swagger.ts`.
- Because the spec is autogenerated, you do not need to hand-write a full OpenAPI document; JSDoc annotations in controllers and models are picked up automatically when configured.

Project structure and folder conventions

- `src/config/` — configuration helpers (database connection, config loaders). Files should export functions or configured clients.
- `src/controllers/` — HTTP controllers. Controllers are versioned; see the Controllers & versioning section.
- `src/interfaces/` — TypeScript interfaces and DTOs.
- `src/middleware/` — Express middleware (auth, validation, error handlers).
- `src/models/` — Mongoose models and schema definitions.
- `src/routes/` — Route registration and routers. Mount versioned controllers here.
- `src/services/` — Business logic and integrations. Controllers call services to keep logic testable.
- `src/utils/` — Utilities such as `password.ts` (argon2 hashing). Keep utilities small and pure where possible.

Every new source file should begin with a short top-file comment describing its purpose. Avoid inline comments between implementation lines — use top-file comments per project convention.

Controllers & versioning

- Place controllers in versioned folders: `src/controllers/v1/`, `src/controllers/v2/`, etc.
- Keep older versions stable. When you need a breaking change, create a new version folder and move the new implementation there.
- Example structure:

```
src/controllers/
	v1/
		auth.controller.ts
		user.controller.ts
	v2/
		user.controller.ts
```

How to add a controller
1. Create `src/controllers/vX/<name>.controller.ts` with a top-file comment describing the file purpose.
2. Export handler functions (async) and keep controllers thin — delegate business logic to `src/services`.
3. Add or update a router in `src/routes` to mount the versioned controllers (for example mount v1 routers at `/api/v1`).

Environment variables and secrets

- `MONGO_URI` — MongoDB connection string
- `PORT` — port the server listens on (default 3000)
- `NODE_ENV` — environment (development|production)

Secrets with Doppler

1. Install and authenticate the Doppler CLI: https://www.doppler.com/docs/cli
2. Run with Doppler-managed secrets injected:

```bash
doppler run -- npm run dev
```

3. (Optional) Export secrets to a `.env` file for testing:

```bash
doppler secrets download --format env --no-file > .env
```

Adding new routes, controllers and models

1. Add model in `src/models/<name>.model.ts` and export the Mongoose model.
2. Add service in `src/services/<name>.service.ts` encapsulating DB calls and business rules.
3. Add controller in `src/controllers/vX/<name>.controller.ts` that calls the service.
4. Add router in `src/routes/<name>.routes.ts` to bind routes to controller handlers and mount the router in `src/app.ts`.

Password utilities

Password hashing utilities are implemented in `src/utils/password.ts` using `argon2`.

Example usage:

```ts
import { hashPassword, verifyPassword } from './utils/password'

const hashed = await hashPassword('s3cret')
const ok = await verifyPassword(hashed, 's3cret')
```

Testing and linting

- Add tests in a `test/` folder and run them with your preferred runner (Jest, Vitest, etc.).
- Add ESLint and Prettier as needed. The project has `skipLibCheck` enabled in `tsconfig.json` to reduce friction with missing types for some packages.

Deployment notes

- Use Doppler to provide production secrets to the runtime environment.
- Build with `npm run build` and run the compiled output with `npm run start`.
- For containerized deployments, ensure `MONGO_URI` and `PORT` are provided to the container environment.

---

Backend Template
